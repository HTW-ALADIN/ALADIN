import{B as U,x as ee,d as T,y as te,_ as X,r as N,c as B,b as w,F as se,n as oe,g as x,o as v,z as re,A as ae,p as ne,a as ce,s as H,u as le,w as L,T as W,h as F,i as V}from"./index-ac1dbb22.js";import{C as ie,D as pe}from"./DecisionNode-89ad19b5.js";import"./index-8ac73e8f.js";const de={name:"ReplayOverlay",props:{replayStore:Object,taskStore:Object},components:{Button:U},setup(u){const i=ee(),{store:h,getProperty:r,setProperty:k}=u.replayStore,c=T(()=>{const e=r("taskReplay");return e||{}}),p=window.innerWidth*.6*.95,l=window.innerWidth*.215,m=e=>{const o={start:new Date().getTime(),duration:0,end:0};return Object.values(e).forEach(t=>{if(!t.length)return;const a=t[0].timestamp,s=t[t.length-1].timestamp;a<o.start&&(o.start=a),s>o.end&&(o.end=s)}),o.duration=o.end-o.start,o},S=(e,o)=>{const{mouse:t}=e;let a=o,s=[];return t.reduce((d,y)=>{const{timestamp:R}=y;return R-a<=50?s.push(y):(d[a]=s,s=[y]),a+=50,d},{})};let g,C,A,f=g,O={};te(c,e=>{k({path:"currentTask",value:e.steps[0].value}),{start:g,duration:C,end:A}=m(e),O=S(e,g),f=g});const Y=e=>({left:`${(c.value.steps[e].timestamp-g)/C*p}px`}),P=(e,o=!1)=>{const t=document.querySelector(".fakeCursor"),{mouse:a}=c.value;if(o){const s=a.filter(n=>n.timestamp<e);if(s.length){const{x:n,y:d}=s[s.length-1];t.style.transform=`translate(${n}px, ${d}px)`}return}e in O&&O[e].forEach(s=>{const{x:n,y:d}=s;t.style.transform=`translate(${n}px, ${d}px)`})};let b={x:5e3,y:5e3};const z=e=>{if(b){const{x:o,y:t}=b;c.value.panning.filter(s=>s.timestamp<e&&s.timestamp>f).forEach(s=>{const n=Math.abs(o)-Math.abs(s.x),d=Math.abs(t)-Math.abs(s.y);window.panzoom.pan(n,d,{relative:!0,animate:!0}),b=window.panzoom.getPan()})}},$=e=>{c.value.zooming.filter(t=>t.timestamp<e&&t.timestamp>f).forEach(t=>{let{scale:a,x:s,y:n}=t;window.panzoom.zoomToPoint(a,{clientX:s,clientY:n},{animate:!0})})},j=e=>{let o=[];e<f?(h.dispatch("clearState"),o=c.value.steps.filter(t=>t.timestamp<e)):o=c.value.steps.filter(t=>t.timestamp<e&&t.timestamp>f),o.forEach(t=>{const{path:a,value:s}=t;k({path:a,value:s})})},G=e=>e/p*C+g,Z=e=>{const t=e.currentTarget.firstChild,a=e.pageX-l;t.style.width=`${a}px`;const s=G(a);f=s,O=S(c.value,s),j(s),P(s,!0),z(s),$(s)};let I,_=!1;const J=e=>{const o=e.currentTarget;if(_){clearInterval(I),_=!_,o.innerHTML="&#9658;";return}o.innerHTML="&#10074; &#10074;",_=!_;const t=50;let a=f;const s=t*p/C,n=document.querySelector(".progress");I=setInterval(()=>{const y=n.offsetWidth+s;y>p&&(clearInterval(I),_=!_,o.innerHTML="&#9658;"),n.style.width=`${y}px`,a+=t,j(a),P(a),z(a),f=a,!b&&window.panzoom&&(b=window.panzoom.getPan())},t)},K=()=>{const e=r("currentTask");["currentTask","layoutSize","currentNode","previousNode","rootNode","topology","edges","nodes","taskData","taskReplay"].forEach(t=>{let a=r(t);t==="taskReplay"&&(a=Object.entries(a).reduce((n,[d,y])=>{if(d==="meta")return n;const R=y.map(M=>{const E=new Date().getTime(),Q=E-M.timestamp;return M.timestamp=E-Q,M});return n[d]=R,n},{})),u.taskStore.setProperty({path:t,value:a}),u.taskStore.store.dispatch("setRestoredFromReplay")}),i.push({name:"Task",params:{task:e}})};let D;return{replayGraph:c,jumpHandler:Z,startStopHandler:J,placeMarker:Y,enterTask:K,fadeControlsIn:e=>{clearTimeout(D);const o=e.target;o.style.opacity="1"},fadeControlsOut:e=>{const o=e.target;D=setTimeout(()=>{o.style.opacity="0.3"},3e3)}}}},ue="/img/fake_cursor.png";const q=u=>(ne("data-v-b424f19c"),u=u(),ce(),u),me={class:"replayOverlay"},fe=q(()=>w("img",{class:"fakeCursor",src:ue},null,-1)),ye=q(()=>w("div",{class:"progress"},null,-1)),_e={class:"controlElements"};function ge(u,i,h,r,k,c){const p=N("Button");return v(),B("div",me,[fe,w("div",{class:"replay",onMouseenter:i[1]||(i[1]=(...l)=>r.fadeControlsIn&&r.fadeControlsIn(...l)),onMouseleave:i[2]||(i[2]=(...l)=>r.fadeControlsOut&&r.fadeControlsOut(...l))},[w("div",{class:"progressBar",onClick:i[0]||(i[0]=(...l)=>r.jumpHandler&&r.jumpHandler(...l))},[ye,(v(!0),B(se,null,oe(r.replayGraph.steps,(l,m)=>(v(),B("div",{class:re(`marker__${m} marker`),style:ae(r.placeMarker(m)),key:l.timestamp}," | ",6))),128))]),w("div",_e,[x(p,{class:"playButton",callback:r.startStopHandler,label:"â–º"},null,8,["callback"]),x(p,{class:"enterButton",callback:r.enterTask,label:"ðŸ—²"},null,8,["callback"])])],32)])}const ve=X(de,[["render",ge],["__scopeId","data-v-b424f19c"]]),he={name:"Replay",components:{Canvas:ie,DecisionNode:pe,ReplayOverlay:ve},setup(){const u=H.taskStore,i=H.replayStore,{store:h,getProperty:r,setProperty:k}=i,c=le();typeof c.params.id=="string"&&h.dispatch("fetchReplayGraph",{id:c.params.id});const p=T(()=>r("currentNode")),l=T(()=>{const S=r(`edges__${p.value}`);return S?S.length>1:!1}),m=T(()=>r("currentNode")!==null);return{currentNode:p,isDecisionNode:l,isLoaded:m,replayStore:i,taskStore:u}}};const ke={class:"task"};function Se(u,i,h,r,k,c){const p=N("DecisionNode"),l=N("Canvas"),m=N("ReplayOverlay");return v(),B("div",ke,[x(W,{name:"slidedown"},{default:L(()=>[r.isDecisionNode?(v(),F(p,{key:0,storeObject:r.replayStore},null,8,["storeObject"])):V("",!0)]),_:1}),x(W,{name:"slidedown"},{default:L(()=>[!r.isDecisionNode&&r.isLoaded?(v(),F(l,{key:r.currentNode,storeObject:r.replayStore},null,8,["storeObject"])):V("",!0)]),_:1}),x(m,{replayStore:r.replayStore,taskStore:r.taskStore},null,8,["replayStore","taskStore"])])}const Te=X(he,[["render",Se],["__scopeId","data-v-05b3d9a7"]]);export{Te as default};
